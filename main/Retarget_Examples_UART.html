<!-- HTML header for doxygen 1.9.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CMSIS-Compiler Support: Retarget Input and Output via UART</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="footer.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><img alt="Logo" src="cmsis_logo_white_small.png"/></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">CMSIS-Compiler Support
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown(this);
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">Debugger Views for Status and Event Information</div>
  </td>
  <!--END !PROJECT_NAME-->
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('Retarget_Examples_UART.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Retarget Input and Output via UART </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Copy the <b>USB</b> <b>Host</b> <b>Keyboard</b> example application to your PC as described in <a class="el" href="Retarget_Examples_Dsip.html">Retarget Input via Keyboard and Output via Display</a>.</p>
<h1><a class="anchor" id="Retarget_Examples_UART_variants"></a>
Variant Selection</h1>
<p >To change the retarget option for <b>STDIN</b> and <b>STDOUT</b> to <b>USART</b>, open the <b>Manage</b> <b>Run-Time</b> <b>Environment</b> window and set the <b>Variants</b> as shown here:</p>
<div class="image">
<img src="SelOutput.png" alt=""/>
<div class="caption">
Select USART as Input and Output Channel</div></div>
<p >This will change the <code>#defines</code> in the RTE_Components.h file and thus execute another code section in <a class="el" href="retarget_io_c.html">retarget_io.c</a>.</p>
<h1><a class="anchor" id="Retarget_Examples_UART_uct"></a>
Add User Code Templates for the USART</h1>
<p >Use the context menu in the Project window to add user code template files to the source code. Right-click on the group <b>Source</b>, select <b>Add new Items to Group</b>. Click on <b>User Code Templates</b>, expand the component <b>Compiler</b>, and add the templates for STDIN and STDOUT via USART.</p>
<div class="image">
<img src="SelTemplatesUART.png" alt=""/>
<div class="caption">
Select Templates for UART Retargeting</div></div>
<p >This adds the files <b>stdin_usart.c</b> and <b>stdout_usart.c</b> to the group <b>Source</b>. The files contain predefined functions which need little modifications if you are using CMSIS-Driver for USARTs.</p>
<h1><a class="anchor" id="Retarget_Examples_UART_cmsis_driver"></a>
Use CMSIS-Driver USART</h1>
<p >But first, enable the CMSIS-Driver in the <b>Manage</b> <b>Run-Time</b> <b>Environment</b> window:</p>
<div class="image">
<img src="CMSIS_Driver_USART.png" alt=""/>
<div class="caption">
Enable the CMSIS-Driver USART</div></div>
<p >The <b>Validation</b> <b>Output</b> window might show related component dependencies. Click <b>Resolve</b> to automatically add the required components to your project.</p>
<h1><a class="anchor" id="Retarget_Examples_UART_configure_USART"></a>
Configure the USART Driver</h1>
<p >Under <b>Device</b>, open the file <b>RTE_Device.h</b> and enable the correct USART (here: <b>USART1</b>). Configure the pins according to your target hardware (refer to the board documentation for further details; here <b>PB6/PB7</b>):</p>
<div class="image">
<img src="RTE_Device_h.png" alt=""/>
<div class="caption">
Device Configuration using RTE_Device.h</div></div>
<h1><a class="anchor" id="Retarget_Examples_UART_connect"></a>
Connect the Retargeting Functions to the Correct Driver Instance</h1>
<p >Open <b>stdout_USART.c</b> and <b>stdin_USART.c</b>. Use the <b>Configuration</b> <b>Wizard</b> view to set the correct hardware interface (here: <b>Driver_USART1</b>) in both files:</p>
<div class="image">
<img src="Driver_Config_Wizard.png" alt=""/>
<div class="caption">
Driver Configuration using the Configuration Wizard</div></div>
<dl class="section note"><dt>Note</dt><dd>To have the full flexibility for retargeting different channels to different target hardware, each user code template contains a function to initialize the underlying hardware. This is fine as long as you are not using the same hardware for multiple channels.</dd></dl>
<h1><a class="anchor" id="Retarget_Examples_UART_code"></a>
Adapt the Code</h1>
<p >In this example, the USART is used for STDIN and STDOUT simultaneously. Thus, one of the initialization functions need to be commented out and the content needs to be merged with the other one. Change to <b>Text</b> <b>Editor</b> mode for both files. In <code>stdout_USART.c</code> comment out the function <code>stdout_init</code> (lines 62 to 83):</p>
<div class="fragment"><div class="line"><span class="comment">//int stdout_init (void) {</span></div>
<div class="line"><span class="comment">//  int32_t status;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//  status = ptrUSART-&gt;Initialize(NULL);</span></div>
<div class="line"><span class="comment">//  if (status != ARM_DRIVER_OK) return (-1);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//  status = ptrUSART-&gt;PowerControl(ARM_POWER_FULL);</span></div>
<div class="line"><span class="comment">//  if (status != ARM_DRIVER_OK) return (-1);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//  status = ptrUSART-&gt;Control(ARM_USART_MODE_ASYNCHRONOUS |</span></div>
<div class="line"><span class="comment">//                             ARM_USART_DATA_BITS_8       |</span></div>
<div class="line"><span class="comment">//                             ARM_USART_PARITY_NONE       |</span></div>
<div class="line"><span class="comment">//                             ARM_USART_STOP_BITS_1       |</span></div>
<div class="line"><span class="comment">//                             ARM_USART_FLOW_CONTROL_NONE,</span></div>
<div class="line"><span class="comment">//                             USART_BAUDRATE);</span></div>
<div class="line"><span class="comment">//  if (status != ARM_DRIVER_OK) return (-1);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//  status = ptrUSART-&gt;Control(ARM_USART_CONTROL_TX, 1);</span></div>
<div class="line"><span class="comment">//  if (status != ARM_DRIVER_OK) return (-1);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//  return (0);</span></div>
<div class="line"><span class="comment">//}</span></div>
</div><!-- fragment --><p >Copy the last call to the <b>Control</b> struct of the USART driver to the <code>stdin_init</code> function (line 62) in <code>stdin_USART.c:</code> </p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> stdin_init (<span class="keywordtype">void</span>) {</div>
<div class="line">  int32_t status;</div>
<div class="line"> </div>
<div class="line">  status = ptrUSART-&gt;Initialize(NULL);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) <span class="keywordflow">return</span> (-1);</div>
<div class="line"> </div>
<div class="line">  status = ptrUSART-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) <span class="keywordflow">return</span> (-1);</div>
<div class="line"> </div>
<div class="line">  status = ptrUSART-&gt;Control(ARM_USART_MODE_ASYNCHRONOUS |</div>
<div class="line">                             ARM_USART_DATA_BITS_8       |</div>
<div class="line">                             ARM_USART_PARITY_NONE       |</div>
<div class="line">                             ARM_USART_STOP_BITS_1       |</div>
<div class="line">                             ARM_USART_FLOW_CONTROL_NONE,</div>
<div class="line">                             USART_BAUDRATE);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) <span class="keywordflow">return</span> (-1);</div>
<div class="line"> </div>
<div class="line">  status = ptrUSART-&gt;Control(ARM_USART_CONTROL_RX, 1);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) <span class="keywordflow">return</span> (-1);</div>
<div class="line"> </div>
<div class="line">  status = ptrUSART-&gt;Control(ARM_USART_CONTROL_TX, 1);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) <span class="keywordflow">return</span> (-1);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">return</span> (0);</div>
<div class="line">}</div>
</div><!-- fragment --><p >The <code>stdin_init()</code> function needs to be called in <code>main</code>. Change the following line in the <code>Keyboard.c</code> file:</p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> stdin_init (<span class="keywordtype">void</span>);</div>
</div><!-- fragment --><p >In <b>main()</b>, replace <code>stdout_init()</code> with <code>stdin_init()</code>:</p>
<div class="fragment"><div class="line">:</div>
<div class="line">SystemClock_Config();                      <span class="comment">/* Configure the System Clock    */</span></div>
<div class="line"> </div>
<div class="line">stdout_init();                             <span class="comment">/* Initialize printf output      */</span></div>
<div class="line"> </div>
<div class="line">ADC_Initialize          ();                <span class="comment">/* Initialize A/D converter      */</span></div>
<div class="line">:</div>
</div><!-- fragment --><h1><a class="anchor" id="Retarget_Examples_UART_remove"></a>
Remove old Template Files</h1>
<p >Before building the project, remove the old user code templates from the target build. Right-click the files <code>stdin_keyboard.c</code> and <code>stdout_display.c</code>, select <b>Options</b> <b>for</b> <b>File</b>, and disable <b>Include</b> <b>in</b> <b>Target</b> <b>Build:</b> </p>
<div class="image">
<img src="FileOptions.png" alt=""/>
<div class="caption">
Remove Unnecessary User Code Template Files from Target Build</div></div>
<h1><a class="anchor" id="Retarget_Examples_UART_run"></a>
Run the Application</h1>
<p >Build the project, configure for debugging, and download the application to the development board. Connect the development board with an RS232 cable to a PC. Open a terminal program with the correct COM port setting and observe that a menu is displayed. Enter a command via your keyboard and test the application:</p>
<div class="image">
<img src="Terminal_Output.png" alt=""/>
<div class="caption">
Input and Output on the Terminal with MCB1800</div></div>
<dl class="section note"><dt>Note</dt><dd>If you do not see any output on the terminal, check the baud rate settings (9600 baud), COM port number, or verify that hte correct USB driver is used (in case you have a USB-Serial converter attached to the PC). </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
